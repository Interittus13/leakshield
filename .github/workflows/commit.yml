name: Gitleaks Commits Scanning

on:
  push:
  workflow_dispatch:

jobs:
  gitleaks:
    name: Gitleaks Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:
      # ---------------------------------
      # Checkout code
      # ---------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------------
      # Run Gitleaks (NO-GIT MODE)
      # ---------------------------------
      - name: Run Gitleaks
        id: gitleaks
        run: |
          docker run --rm \
            -v $PWD:/repo \
            zricethezav/gitleaks:latest detect \
            --source=/repo \
            # --no-git \
            --config=/repo/gitleaks.toml \
            --report-format json \
            --report-path /repo/gitleaks-report.json \
            --exit-code 1 \
            --redact
        continue-on-error: true

      # ---------------------------------
      # Show findings in logs
      # ---------------------------------
      - name: Show detected secrets
        if: steps.gitleaks.outcome == 'failure'
        run: cat gitleaks-report.json

      # ---------------------------------
      # Gitleaks Summary Table
      # ---------------------------------
      - name: Add summary (Gitleaks UI style)
        if: steps.gitleaks.outcome == 'failure'
        shell: bash
        run: |
          REPO_URL="https://github.com/${{ github.repository }}"
          REF="${{ github.ref_name }}"

          {
            echo "## ðŸ”´ Gitleaks detected secrets ðŸ”´"
            echo ""
            echo "| Rule ID | Commit | Secret URL | Start Line | Author | Date | Email | File |"
            echo "|--------|--------|------------|------------|--------|------|-------|------|"
          } >> "$GITHUB_STEP_SUMMARY"

          jq -c '.[]' gitleaks-report.json | while read -r row; do
            RULE_ID=$(echo "$row" | jq -r '.RuleID')
            FILE=$(echo "$row" | jq -r '.File | sub("^/repo/"; "")')
            LINE=$(echo "$row" | jq -r '.StartLine')
            COMMIT=$(echo "$row" | jq -r '.Commit // "N/A"')
            AUTHOR=$(echo "$row" | jq -r '.Author // "N/A"')
            DATE=$(echo "$row" | jq -r '.Date // "N/A"')
            EMAIL=$(echo "$row" | jq -r '.Email // "N/A"')

            echo "| $RULE_ID | $COMMIT | [View Secret]($REPO_URL/blob/$REF/$FILE#L$LINE) | $LINE | $AUTHOR | $DATE | $EMAIL | $FILE |" \
              >> "$GITHUB_STEP_SUMMARY"
          done

      # ---------------------------------
      # Create GitHub Issue
      # ---------------------------------
      - name: Create GitHub Issue
        if: github.event_name == 'push' && steps.gitleaks.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ðŸ”´ Secrets detected by Gitleaks",
              body: "Gitleaks detected secrets. Please rotate credentials immediately.",
              labels: ["security", "gitleaks"]
            });

      # ---------------------------------
      # Fail workflow
      # ---------------------------------
      - name: Fail workflow
        if: steps.gitleaks.outcome == 'failure'
        run: exit 1
