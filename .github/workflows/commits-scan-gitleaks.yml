name: Gitleaks Commits Scanning

on:
  push:
  workflow_dispatch:

jobs:
  gitleaks:
    name: Gitleaks Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:

      # ---------------------------------
      # Checkout minimal commits only
      # Faster than full history clone
      # ---------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      # ---------------------------------
      # Run Gitleaks using Docker
      # Scans ONLY changed commits
      # ---------------------------------
      - name: Run Gitleaks
        id: gitleaks
        run: |
          BEFORE="${{ github.event.before }}"
          SHA="${{ github.sha }}"

          echo "before=$BEFORE"
          echo "sha=$SHA"

          # If first push or invalid before SHA
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            RANGE="$SHA"
          else
            RANGE="$BEFORE..$SHA"
          fi

          echo "Scanning range: $RANGE"

          docker run --rm \
          -v $PWD:/repo \
          zricethezav/gitleaks:latest detect \
          --source=/repo \
          --log-opts="$RANGE" \
          --config=/repo/gitleaks.toml \
          --report-format sarif \
          --report-path /repo/gitleaks-report.sarif \
          --exit-code 1 \
          --redact
        continue-on-error: true


      # ---------------------------------
      # Upload SARIF to GitHub Security tab
      # ---------------------------------
      - name: Upload SARIF
        if: steps.gitleaks.outcome == 'failure'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks-report.sarif


      # ---------------------------------
      # Generate GitHub summary table from SARIF (same as official action)
      # ---------------------------------
      - name: Generate summary table
        if: steps.gitleaks.outcome == 'failure'
        run: |
          node <<'EOF'
          const fs = require('fs');

          const repo = process.env.GITHUB_REPOSITORY;
          const sha = process.env.GITHUB_SHA;
          const repoUrl = `https://github.com/${repo}`;
          const sarif = JSON.parse(fs.readFileSync('gitleaks-report.sarif', 'utf8'));

          const results = sarif.runs[0].results || [];

          let summary = `## ðŸ›‘ Gitleaks detected secrets ðŸ›‘\n\n`;
          summary += `| Rule ID | Commit | Secret URL | Start Line | File |\n`;
          summary += `|---------|--------|------------|------------|------|\n`;

          results.forEach(r => {
            const commit = r.partialFingerprints.commitSha;
            const file = r.locations[0].physicalLocation.artifactLocation.uri;
            const line = r.locations[0].physicalLocation.region.startLine;

            const commitUrl = `${repoUrl}/commit/${commit}`;
            const secretUrl = `${repoUrl}/blob/${commit}/${file}#L${line}`;

            summary += `| ${r.ruleId} | [${commit.substring(0,7)}](${commitUrl}) | [View Secret](${secretUrl}) | ${line} | ${file} |\n`;
          });

          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
          EOF


      # # ---------------------------------
      # # Show findings in logs
      # # ---------------------------------
      # - name: Show detected secrets
      #   if: steps.gitleaks.outcome == 'failure'
      #   run: |
      #     cat gitleaks-report.sarif


      # # ---------------------------------
      # # Add pretty summary
      # # ---------------------------------
      # - name: Add summary
      #   if: steps.gitleaks.outcome == 'failure'
      #   run: |
      #     echo "## ðŸš¨ Gitleaks Findings" >> $GITHUB_STEP_SUMMARY
      #     cat gitleaks-report.sarif >> $GITHUB_STEP_SUMMARY


      # ---------------------------------
      # Create issue only for push
      # ---------------------------------
      - name: Create GitHub Issue
        if: github.event_name == 'push' && steps.gitleaks.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Secrets detected by Gitleaks';

            const body = `
            **Security Alert**

            Secrets were detected in the repository.

            **Repository:** ${context.repo.owner}/${context.repo.repo}
            **Branch:** ${context.ref.replace('refs/heads/', '')}
            **Commit:** ${context.sha}
            **Triggered by:** ${context.actor}

            Action required:
            - Remove the secret from the codebase
            - Rotate the exposed credentials immediately

            ---
            _This issue was automatically created by github-actions[bot]._
            `;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,gitleaks'
            });

            const existingIssue = issues.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['security', 'gitleaks', 'automated']
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: existingIssue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `
                New secret detected

                **Commit:** ${context.sha}
                **Triggered by:** @${context.actor}
                `
              });
            }

      # ---------------------------------
      # Send external email alert on secret detection
      # ---------------------------------
      - name: Send Email Alert
        if: steps.gitleaks.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸš¨ Gitleaks Alert: Secrets detected in ${{ github.repository }}"
          to: ${{ secrets.ALERT_EMAILS }}
          from: "Gitleaks CI <${{ secrets.SMTP_USERNAME }}>"
          body: |
            ðŸš¨ SECURITY ALERT

            Gitleaks detected secrets in the repository.

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Actor: ${{ github.actor }}

            Immediate actions required:
            - Remove the exposed secret
            - Rotate the credential immediately
            - Re-run the pipeline

            This alert was sent automatically by GitHub Actions.

      # ---------------------------------
      # Finally fail job
      # ---------------------------------
      - name: Fail workflow if secrets detected
        if: steps.gitleaks.outcome == 'failure'
        run: exit 1
