name: Gitleaks Commits Scanning

on:
  push:
  workflow_dispatch:

jobs:
  gitleaks:
    name: Gitleaks Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:

      # ---------------------------------
      # Checkout code
      # ---------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------------
      # Run Gitleaks (NO-GIT MODE)
      # ---------------------------------
      - name: Run Gitleaks
        id: gitleaks
        run: |
          docker run --rm \
            -v $PWD:/repo \
            zricethezav/gitleaks:latest detect \
            --source=/repo \
            --no-git \
            --config=/repo/.gitleaks.toml \
            --report-format json \
            --report-path /repo/gitleaks-report.json \
            --exit-code 1 \
            --redact
        continue-on-error: true

      # ---------------------------------
      # Show findings in logs
      # ---------------------------------
      - name: Show detected secrets
        if: steps.gitleaks.outcome == 'failure'
        run: |
          cat gitleaks-report.json

      # ---------------------------------
      # Gitleaks-style Summary Table
      # ---------------------------------
      - name: Add summary (Gitleaks UI style)
        if: steps.gitleaks.outcome == 'failure'
        run: |
          REPO_URL="https://github.com/${{ github.repository }}"
          REF="${{ github.ref_name }}"

          {
            echo "## üî¥ Gitleaks detected secrets üî¥"
            echo ""
            echo "| Rule ID | Commit | Secret URL | Start Line | Author | Date | Email | File |"
            echo "|--------|--------|------------|------------|--------|------|-------|------|"

            jq -r --arg repo "$REPO_URL" --arg ref "$REF" '
              .[] |
              "| \(.RuleID) | " +
              (if .Commit != "" then .Commit[0:7] else "N/A" end) + " | " +
              "[View Secret](" +
                $repo + "/blob/" + $ref + "/" +
                (.File | sub(\"^/repo/\"; \"\")) +
                \"#L\" + (.StartLine|tostring) +
              ") | " +
              (.StartLine|tostring) + " | " +
              (if .Author != "" then .Author else "N/A" end) + " | " +
              (if .Date != "" then .Date else "N/A" end) + " | " +
              (if .Email != "" then .Email else "N/A" end) + " | " +
              (.File | sub(\"^/repo/\"; \"\")) +
              " |"
            ' gitleaks-report.json
          } >> "$GITHUB_STEP_SUMMARY"

      # ---------------------------------
      # Create GitHub Issue (push only)
      # ---------------------------------
      - name: Create GitHub Issue
        if: github.event_name == 'push' && steps.gitleaks.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Secrets detected by Gitleaks';

            const body = `
            **üî¥ Security Alert**

            Gitleaks detected secrets in this repository.

            **Repository:** ${context.repo.owner}/${context.repo.repo}
            **Branch:** ${context.ref.replace('refs/heads/', '')}
            **Triggered by:** ${context.actor}

            **Immediate actions required:**
            - Remove secrets from code
            - Rotate exposed credentials
            - Audit access logs

            ---
            _Automatically created by github-actions[bot]_
            `;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,gitleaks'
            });

            const existingIssue = issues.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['security', 'gitleaks', 'automated']
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: existingIssue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `
                üîÅ **New secret detected**

                **Triggered by:** @${context.actor}
                `
              });
            }

      # ---------------------------------
      # Fail workflow
      # ---------------------------------
      - name: Fail workflow if secrets detected
        if: steps.gitleaks.outcome == 'failure'
        run: exit 1

