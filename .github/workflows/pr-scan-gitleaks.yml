name: Gitleaks PR Scanning

on:
  pull_request:
  workflow_dispatch:

jobs:
  gitleaks:
    name: Gitleaks Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:

      # ---------------------------------
      # Checkout minimal commits only
      # Faster than full history clone
      # ---------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      # ---------------------------------
      # Get changed files only
      # This avoids git history scanning completely
      # ---------------------------------
      - name: Get changed files
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.base.sha }} --depth=1
            FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | tr '\n' ' ')
          else
            FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | tr '\n' ' ')
          fi

          echo "FILES=$FILES" >> $GITHUB_ENV


      # ---------------------------------
      # Run gitleaks ONLY on changed files
      # This is 100% deterministic
      # ---------------------------------
      - name: Run Gitleaks
        id: gitleaks
        run: |
          docker run --rm \
              -v $PWD:/repo \
              zricethezav/gitleaks:latest detect \
              --source=/repo \
              --log-opts="$RANGE" \
              --config=/repo/gitleaks.toml \
              --report-format json \
              --report-path /repo/gitleaks-report.json \
              --redact \
              --exit-code 1
        continue-on-error: true


      # ---------------------------------
      # Show findings in logs
      # ---------------------------------
      - name: Show detected secrets
        if: steps.gitleaks.outcome == 'failure'
        run: |
          cat gitleaks-report.json


      # ---------------------------------
      # Add pretty summary
      # ---------------------------------
      - name: Add summary
        if: steps.gitleaks.outcome == 'failure'
        run: |
          echo "## ðŸš¨ Gitleaks Findings" >> $GITHUB_STEP_SUMMARY
          cat gitleaks-report.json >> $GITHUB_STEP_SUMMARY

      # ---------------------------------
      # PR comment only if failed
      # ---------------------------------
      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.gitleaks.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              **Gitleaks Alert â€“ Secrets Detected**

              Secrets were detected in this PR.

              **Repository:** ${context.repo.owner}/${context.repo.repo}
              **PR:** #${context.issue.number}
              **Commit:** ${context.sha}

              Please remove the secret immediately and rotate any exposed credentials.
              `
            });

      # ---------------------------------
      # Finally fail job
      # ---------------------------------
      - name: Fail workflow if secrets detected
        if: steps.gitleaks.outcome == 'failure'
        run: exit 1
